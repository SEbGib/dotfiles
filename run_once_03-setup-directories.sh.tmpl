#!/bin/bash

set -eufo pipefail

echo "üìÅ Configuration des dossiers de d√©veloppement..."

# Cr√©ation des dossiers principaux
echo "üì¶ Cr√©ation des dossiers de base..."

# Dossiers essentiels
mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.config"
mkdir -p "$HOME/.cache"
mkdir -p "$HOME/projects"

{{- if (index . "personal" | default false) }}
mkdir -p "$HOME/personal"
echo "  ‚úÖ Dossier personnel cr√©√©"
{{- end }}

{{- if (index . "work" | default false) }}
mkdir -p "$HOME/work"
mkdir -p "$HOME/company"
echo "  ‚úÖ Dossiers professionnels cr√©√©s"
{{- end }}

# Dossiers utilitaires
mkdir -p "$HOME/projects/scripts"
mkdir -p "$HOME/projects/dotfiles"
mkdir -p "$HOME/projects/learning"
mkdir -p "$HOME/projects/sandbox"

echo "  ‚úÖ Dossiers de d√©veloppement cr√©√©s"

# Configuration des dossiers tmux
echo "üì¶ Configuration tmux..."
mkdir -p "$HOME/.config/tmux/scripts"
mkdir -p "$HOME/.config/tmux/themes"

# Configuration des dossiers Neovim
echo "üì¶ Configuration Neovim..."
mkdir -p "$HOME/.config/nvim/lua"
mkdir -p "$HOME/.config/nvim/after/plugin"

# Dossiers SSH et GPG
echo "üîê Configuration s√©curit√©..."
mkdir -p "$HOME/.ssh"
chmod 700 "$HOME/.ssh"

mkdir -p "$HOME/.gnupg"
chmod 700 "$HOME/.gnupg"

# Dossiers de cache et donn√©es
echo "üíæ Configuration cache et donn√©es..."
mkdir -p "$HOME/.cache/zsh"
mkdir -p "$HOME/.cache/nvim"
mkdir -p "$HOME/.cache/tmux"

# Dossiers sp√©cifiques aux outils
{{- if lookPath "node" }}
mkdir -p "$HOME/.npm-global"
echo "  ‚úÖ Dossier npm global cr√©√©"
{{- end }}

{{- if lookPath "composer" }}
mkdir -p "$HOME/.composer"
echo "  ‚úÖ Dossier Composer cr√©√©"
{{- end }}

# Configuration des permissions
echo "üîí Configuration des permissions..."
chmod 755 "$HOME/.local/bin"
chmod 755 "$HOME/projects"

# Cr√©ation de fichiers de configuration vides si n√©cessaires
echo "üìÑ Cr√©ation des fichiers de configuration..."

# Fichier d'environnement local
touch "$HOME/.env"
chmod 600 "$HOME/.env"

# Fichiers de configuration locale
touch "$HOME/.zshrc.local"
touch "$HOME/.gitconfig.local"
touch "$HOME/.tmux.conf.local"

# Fichier d'historique Zsh
touch "$HOME/.zsh_history"
chmod 600 "$HOME/.zsh_history"

{{- if eq .chezmoi.os "darwin" }}
# Configuration sp√©cifique macOS
echo "üçé Configuration sp√©cifique macOS..."

# Dossiers Applications
mkdir -p "$HOME/Applications"

# Configuration Homebrew
if [[ -d "/opt/homebrew" ]]; then
    mkdir -p "$HOME/.config/homebrew"
fi
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# Configuration sp√©cifique Linux
echo "üêß Configuration sp√©cifique Linux..."

# Dossiers XDG
mkdir -p "$HOME/.local/share"
mkdir -p "$HOME/.local/state"

# Configuration systemd utilisateur
mkdir -p "$HOME/.config/systemd/user"
{{- end }}

# Cr√©ation d'un fichier de bienvenue dans projects
cat > "$HOME/projects/README.md" << 'EOF'

## üìö Workflows

- `dev-symfony <nom>` : Cr√©e une session tmux compl√®te pour Symfony
- `dev-ts <nom>` : Cr√©e une session tmux compl√®te pour TypeScript
- `ts` : S√©lecteur de projet interactif avec fzf
EOF

echo ""
echo "‚úÖ Configuration des dossiers termin√©e!"
echo ""
echo "üìã Dossiers cr√©√©s :"
echo "   ‚Ä¢ ~/.local/bin (binaires personnels)"
echo "   ‚Ä¢ ~/projects/* (projets de d√©veloppement)"
{{- if (index . "personal" | default false) }}
echo "   ‚Ä¢ ~/personal (projets personnels)"
{{- end }}
{{- if (index . "work" | default false) }}
echo "   ‚Ä¢ ~/work et ~/company (projets professionnels)"
{{- end }}
echo "   ‚Ä¢ ~/.config/* (configurations)"
echo "   ‚Ä¢ ~/.cache/* (cache applications)"
echo ""
echo "üîê S√©curit√© :"
echo "   ‚Ä¢ Permissions SSH et GPG configur√©es (700)"
echo "   ‚Ä¢ Fichier .env cr√©√© avec permissions restrictives (600)"
echo ""
echo "üìÑ Fichiers de configuration locale cr√©√©s :"
echo "   ‚Ä¢ ~/.zshrc.local"
echo "   ‚Ä¢ ~/.gitconfig.local" 
echo "   ‚Ä¢ ~/.tmux.conf.local"
echo ""
echo "üí° Consultez ~/projects/README.md pour les workflows de d√©veloppement"