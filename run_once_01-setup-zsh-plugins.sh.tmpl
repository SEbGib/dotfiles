#!/bin/bash

set -eufo pipefail

echo "ğŸš Configuration des plugins Zsh modernes..."

# VÃ©rification que Zsh est installÃ©
if ! command -v zsh &> /dev/null; then
    echo "âŒ Zsh non installÃ©. ExÃ©cutez d'abord le script d'installation des outils."
    exit 1
fi

# Installation Oh My Zsh si absent
ZSH_DIR="$HOME/.oh-my-zsh"
if [[ ! -d "$ZSH_DIR" ]]; then
    echo "ğŸ“¦ Installation Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    echo "âœ… Oh My Zsh installÃ©"
fi

# DÃ©finition du rÃ©pertoire des plugins personnalisÃ©s
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
PLUGINS_DIR="$ZSH_CUSTOM/plugins"

# CrÃ©ation du rÃ©pertoire des plugins si nÃ©cessaire
mkdir -p "$PLUGINS_DIR"

echo "ğŸ“¦ Installation des plugins Zsh essentiels..."

# Plugin zsh-autosuggestions (suggestions basÃ©es sur l'historique)
if [[ ! -d "$PLUGINS_DIR/zsh-autosuggestions" ]]; then
    echo "  â€¢ zsh-autosuggestions..."
    git clone https://github.com/zsh-users/zsh-autosuggestions "$PLUGINS_DIR/zsh-autosuggestions"
else
    echo "  âœ“ zsh-autosuggestions dÃ©jÃ  installÃ©"
fi

# Plugin fast-syntax-highlighting (coloration syntaxique rapide)
if [[ ! -d "$PLUGINS_DIR/fast-syntax-highlighting" ]]; then
    echo "  â€¢ fast-syntax-highlighting..."
    git clone https://github.com/zdharma-continuum/fast-syntax-highlighting "$PLUGINS_DIR/fast-syntax-highlighting"
else
    echo "  âœ“ fast-syntax-highlighting dÃ©jÃ  installÃ©"
fi

# Plugin zsh-completions (complÃ©tion avancÃ©e)
if [[ ! -d "$PLUGINS_DIR/zsh-completions" ]]; then
    echo "  â€¢ zsh-completions..."
    git clone https://github.com/zsh-users/zsh-completions "$PLUGINS_DIR/zsh-completions"
else
    echo "  âœ“ zsh-completions dÃ©jÃ  installÃ©"
fi

# Plugin zsh-history-substring-search (recherche dans l'historique)
if [[ ! -d "$PLUGINS_DIR/zsh-history-substring-search" ]]; then
    echo "  â€¢ zsh-history-substring-search..."
    git clone https://github.com/zsh-users/zsh-history-substring-search "$PLUGINS_DIR/zsh-history-substring-search"
else
    echo "  âœ“ zsh-history-substring-search dÃ©jÃ  installÃ©"
fi

# Plugin zsh-z (navigation rapide avec z)
if [[ ! -d "$PLUGINS_DIR/zsh-z" ]]; then
    echo "  â€¢ zsh-z..."
    git clone https://github.com/agkozak/zsh-z "$PLUGINS_DIR/zsh-z"
else
    echo "  âœ“ zsh-z dÃ©jÃ  installÃ©"
fi

# Plugin zsh-bat (intÃ©gration bat pour cat)
if [[ ! -d "$PLUGINS_DIR/zsh-bat" ]] && command -v bat &> /dev/null; then
    echo "  â€¢ zsh-bat..."
    git clone https://github.com/fdellwing/zsh-bat "$PLUGINS_DIR/zsh-bat"
else
    echo "  âœ“ zsh-bat dÃ©jÃ  installÃ© ou bat non disponible"
fi

# Configuration des thÃ¨mes pour fast-syntax-highlighting
echo "ğŸ¨ Configuration des thÃ¨mes de coloration..."
FSH_THEMES_DIR="$PLUGINS_DIR/fast-syntax-highlighting/themes"
if [[ -d "$FSH_THEMES_DIR" ]]; then
    # CrÃ©er un thÃ¨me Catppuccin personnalisÃ©
    cat > "$FSH_THEMES_DIR/catppuccin-mocha.ini" << 'EOF'
; ThÃ¨me Catppuccin Mocha pour fast-syntax-highlighting
; CoordonnÃ© avec la configuration Starship et Neovim

[base]
default          = fg=#cdd6f4
unknown-token    = fg=#f38ba8,bold
commandseparator = fg=#89dceb
redirection      = fg=#f9e2af
here-string-tri  = fg=#fab387
here-string-text = fg=#a6e3a1
here-string-var  = fg=#89b4fa,bold
exec-descriptor  = fg=#f9e2af,bold
comment          = fg=#6c7086,italic
correct-subtle   = fg=#313244,bg=#f38ba8
incorrect-subtle = fg=#f38ba8,bg=#313244
subtle-separator = fg=#585b70
subtle-bg        = bg=#313244

[command-point]
reserved-word     = fg=#cba6f7,bold
alias             = fg=#a6e3a1,bold
suffix-alias      = fg=#a6e3a1,bold
global-alias      = fg=#fab387,bold
builtin           = fg=#89b4fa,bold
function          = fg=#94e2d5,bold
command           = fg=#89b4fa,bold
precommand        = fg=#cba6f7,italic
commandseparator  = fg=#f38ba8
hashed-command    = fg=#89b4fa
single-sq-bracket = fg=#f9e2af
double-sq-bracket = fg=#f9e2af
double-paren      = fg=#f9e2af

[paths]
path              = fg=#89dceb,underline
pathseparator     = fg=#f38ba8
path-to-dir       = fg=#89dceb,underline,bold
globbing          = fg=#fab387,bold
globbing-ext      = fg=#f38ba8,bold

[brackets]
paired-bracket    = fg=#f9e2af,bold
bracket-level-1   = fg=#89b4fa,bold
bracket-level-2   = fg=#a6e3a1,bold
bracket-level-3   = fg=#f38ba8,bold

[arguments]
single-hyphen-option   = fg=#fab387
double-hyphen-option   = fg=#fab387,bold
back-quoted-argument   = fg=#cba6f7
single-quoted-argument = fg=#a6e3a1
double-quoted-argument = fg=#a6e3a1
dollar-quoted-argument = fg=#a6e3a1

[in-string]
back-dollar-quoted-argument      = fg=#89b4fa
back-quoted-argument-unclosed    = fg=#f38ba8
single-quoted-argument-unclosed  = fg=#f38ba8
double-quoted-argument-unclosed  = fg=#f38ba8
dollar-quoted-argument-unclosed  = fg=#f38ba8

[variables]
assign                    = fg=#cdd6f4
assign-array-bracket      = fg=#f9e2af
history-expansion         = fg=#cba6f7,bold
EOF

    echo "âœ… ThÃ¨me Catppuccin Mocha crÃ©Ã© pour fast-syntax-highlighting"
fi

# Mise Ã  jour des plugins existants
echo "ğŸ”„ Mise Ã  jour des plugins existants..."
for plugin in zsh-autosuggestions fast-syntax-highlighting zsh-completions zsh-history-substring-search zsh-z zsh-bat; do
    plugin_dir="$PLUGINS_DIR/$plugin"
    if [[ -d "$plugin_dir" ]]; then
        echo "  â€¢ Mise Ã  jour $plugin..."
        (cd "$plugin_dir" && git pull --quiet)
    fi
done

# Configuration des keybindings pour zsh-history-substring-search
echo "âŒ¨ï¸ Configuration des raccourcis clavier..."
ZSHRC_FILE="$HOME/.zshrc"

# VÃ©rifier si les keybindings sont dÃ©jÃ  configurÃ©s
if [[ -f "$ZSHRC_FILE" ]] && ! grep -q "history-substring-search-up" "$ZSHRC_FILE"; then
    cat >> "$ZSHRC_FILE" << 'EOF'

# ===== KEYBINDINGS POUR PLUGINS =====
# zsh-history-substring-search
bindkey '^[[A' history-substring-search-up      # FlÃ¨che haut
bindkey '^[[B' history-substring-search-down    # FlÃ¨che bas
bindkey '^P' history-substring-search-up        # Ctrl+P
bindkey '^N' history-substring-search-down      # Ctrl+N

# Navigation amÃ©liorÃ©e
bindkey '^[[1;5C' forward-word                  # Ctrl+Right
bindkey '^[[1;5D' backward-word                 # Ctrl+Left
bindkey '^[[H' beginning-of-line                # Home
bindkey '^[[F' end-of-line                      # End
bindkey '^[[3~' delete-char                     # Delete

# Autosuggestions
bindkey '^ ' autosuggest-accept                 # Ctrl+Space pour accepter suggestion
bindkey '^I' complete-word                      # Tab pour complÃ©tion

# Ã‰dition rapide
bindkey '^X^E' edit-command-line                # Ctrl+X Ctrl+E pour Ã©diter dans $EDITOR
EOF
    echo "âœ… Keybindings configurÃ©s dans .zshrc"
fi

# Validation de l'installation
echo ""
echo "ğŸ” Validation de l'installation..."
validation_passed=true

required_plugins=(
    "zsh-autosuggestions"
    "fast-syntax-highlighting" 
    "zsh-completions"
    "zsh-history-substring-search"
)

for plugin in "${required_plugins[@]}"; do
    if [[ -d "$PLUGINS_DIR/$plugin" ]]; then
        echo "  âœ… $plugin"
    else
        echo "  âŒ $plugin"
        validation_passed=false
    fi
done

# VÃ©rification que Starship est installÃ©
if command -v starship &> /dev/null; then
    echo "  âœ… starship"
else
    echo "  âŒ starship (requis pour le prompt)"
    validation_passed=false
fi

if [[ "$validation_passed" == true ]]; then
    echo ""
    echo "ğŸ‰ Configuration Zsh terminÃ©e avec succÃ¨s!"
    echo ""
    echo "ğŸ“‹ Plugins installÃ©s :"
    echo "   â€¢ zsh-autosuggestions : Suggestions intelligentes basÃ©es sur l'historique"
    echo "   â€¢ fast-syntax-highlighting : Coloration syntaxique en temps rÃ©el"
    echo "   â€¢ zsh-completions : ComplÃ©tion avancÃ©e pour de nombreux outils"
    echo "   â€¢ zsh-history-substring-search : Recherche dans l'historique avec â†‘/â†“"
    echo "   â€¢ zsh-z : Navigation rapide avec la commande 'z'"
    echo ""
    echo "ğŸ¨ ThÃ¨me Catppuccin Mocha configurÃ© pour coordination avec Neovim et tmux"
    echo ""
    echo "âŒ¨ï¸ Raccourcis clavier configurÃ©s :"
    echo "   â€¢ â†‘/â†“ ou Ctrl+P/N : Recherche dans l'historique"
    echo "   â€¢ Ctrl+Space : Accepter suggestion"
    echo "   â€¢ Ctrl+â† / â†’ : Navigation par mots"
    echo "   â€¢ Ctrl+X Ctrl+E : Ã‰diter commande dans \$EDITOR"
    echo ""
    echo "ğŸ”„ RedÃ©marrez votre terminal ou exÃ©cutez 'exec zsh' pour activer les changements."
else
    echo ""
    echo "âš ï¸ Certains plugins n'ont pas pu Ãªtre installÃ©s. VÃ©rifiez votre connexion internet."
    echo "ğŸ’¡ Vous pouvez rÃ©-exÃ©cuter ce script plus tard."
    exit 1
fi
